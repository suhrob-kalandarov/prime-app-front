<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Just Online Store</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="admin.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
<!-- Admin Header -->
<div class="admin-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h1 class="admin-title">Admin Panel</h1>
                <p class="admin-subtitle">Just Online Store boshqaruv paneli</p>
            </div>
            <div class="col-md-6 text-md-end">
                <button class="btn btn-light me-2" onclick="goToMainSite()">
                    <i class="fas fa-home me-2"></i>Asosiy saytga o'tish
                </button>
                <button class="btn btn-outline-light" onclick="logout()">
                    <i class="fas fa-sign-out-alt me-2"></i>Chiqish
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Admin Navigation -->
<div class="admin-nav">
    <div class="container">
        <ul class="nav nav-tabs" id="adminTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab">
                    <i class="fas fa-chart-bar me-2"></i>Dashboard
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="categories-tab" data-bs-toggle="tab" data-bs-target="#categories" type="button" role="tab">
                    <i class="fas fa-tags me-2"></i>Kategoriyalar
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="products-tab" data-bs-toggle="tab" data-bs-target="#products" type="button" role="tab">
                    <i class="fas fa-box me-2"></i>Mahsulotlar
                </button>
            </li>
        </ul>
    </div>
</div>

<!-- Admin Content -->
<div class="admin-content">
    <div class="container">
        <div class="tab-content" id="adminTabsContent">

            <!-- Dashboard Tab -->
            <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
                <div class="row">
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="stats-card">
                            <div class="stats-number" id="total-categories">0</div>
                            <div class="stats-label">Kategoriyalar</div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="stats-card" style="background: linear-gradient(135deg, var(--success-color), #20c997);">
                            <div class="stats-number" id="total-products">0</div>
                            <div class="stats-label">Mahsulotlar</div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="stats-card" style="background: linear-gradient(135deg, var(--warning-color), #fd7e14);">
                            <div class="stats-number" id="low-stock-products">0</div>
                            <div class="stats-label">Kam qolgan</div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="stats-card" style="background: linear-gradient(135deg, var(--info-color), #6f42c1);">
                            <div class="stats-number" id="total-users">0</div>
                            <div class="stats-label">Foydalanuvchilar</div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-lg-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title">So'nggi qo'shilgan kategoriyalar</h5>
                            </div>
                            <div class="card-body">
                                <div id="recent-categories">
                                    <div class="loading show">
                                        <div class="spinner"></div>
                                        <p>Yuklanmoqda...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title">So'nggi qo'shilgan mahsulotlar</h5>
                            </div>
                            <div class="card-body">
                                <div id="recent-products">
                                    <div class="loading show">
                                        <div class="spinner"></div>
                                        <p>Yuklanmoqda...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Categories Tab -->
            <div class="tab-pane fade" id="categories" role="tabpanel">
                <div class="row">
                    <div class="col-lg-4 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title">Kategoriya qo'shish</h5>
                            </div>
                            <div class="card-body">
                                <form id="category-form">
                                    <div class="mb-3">
                                        <label class="form-label">Kategoriya nomi *</label>
                                        <input type="text" class="form-control" id="category-name" required>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Rasm (ixtiyoriy)</label>
                                        <div class="file-upload-area" id="category-upload-area">
                                            <i class="fas fa-cloud-upload-alt fa-2x mb-3"></i>
                                            <p>Rasm yuklash uchun bosing yoki shu yerga tashlang</p>
                                            <input type="file" id="category-file-input" accept="image/*" style="display: none;">
                                        </div>
                                        <div class="uploaded-files" id="category-uploaded-files"></div>
                                    </div>

                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="category-active" checked>
                                            <label class="form-check-label" for="category-active">
                                                Faol
                                            </label>
                                        </div>
                                    </div>

                                    <button type="submit" class="btn btn-custom w-100" id="category-submit-btn">
                                        <i class="fas fa-plus me-2"></i>Kategoriya qo'shish
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-8 mb-4">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="card-title">Kategoriyalar ro'yxati</h5>
                                <button class="btn btn-outline-light btn-sm" onclick="loadCategories()">
                                    <i class="fas fa-sync-alt me-2"></i>Yangilash
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="loading" id="categories-loading">
                                    <div class="spinner"></div>
                                    <p>Yuklanmoqda...</p>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Rasm</th>
                                            <th>Nomi</th>
                                            <th>Holati</th>
                                            <th>Amallar</th>
                                        </tr>
                                        </thead>
                                        <tbody id="categories-table-body">
                                        <!-- Categories will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Products Tab -->
            <div class="tab-pane fade" id="products" role="tabpanel">
                <div class="row">
                    <div class="col-lg-4 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title">Mahsulot qo'shish</h5>
                            </div>
                            <div class="card-body">
                                <form id="product-form">
                                    <div class="mb-3">
                                        <label class="form-label">Mahsulot nomi *</label>
                                        <input type="text" class="form-control" id="product-name" required>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Tavsif</label>
                                        <textarea class="form-control" id="product-description" rows="3"></textarea>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Narx (So'm) *</label>
                                        <input type="number" class="form-control" id="product-price" step="0.01" required>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Miqdor *</label>
                                        <input type="number" class="form-control" id="product-amount" required>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Kategoriya *</label>
                                        <select class="form-select" id="product-category" required>
                                            <option value="">Kategoriyani tanlang</option>
                                            <!-- Categories will be loaded here -->
                                        </select>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Rasmlar (ixtiyoriy)</label>
                                        <div class="file-upload-area" id="product-upload-area">
                                            <i class="fas fa-cloud-upload-alt fa-2x mb-3"></i>
                                            <p>Rasmlarni yuklash uchun bosing yoki shu yerga tashlang</p>
                                            <input type="file" id="product-file-input" accept="image/*" multiple style="display: none;">
                                        </div>
                                        <div class="uploaded-files" id="product-uploaded-files"></div>
                                    </div>

                                    <button type="submit" class="btn btn-custom w-100" id="product-submit-btn">
                                        <i class="fas fa-plus me-2"></i>Mahsulot qo'shish
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-8 mb-4">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="card-title">Mahsulotlar ro'yxati</h5>
                                <button class="btn btn-outline-light btn-sm" onclick="loadProducts()">
                                    <i class="fas fa-sync-alt me-2"></i>Yangilash
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="loading" id="products-loading">
                                    <div class="spinner"></div>
                                    <p>Yuklanmoqda...</p>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Rasm</th>
                                            <th>Nomi</th>
                                            <th>Narx</th>
                                            <th>Miqdor</th>
                                            <th>Kategoriya</th>
                                            <th>Amallar</th>
                                        </tr>
                                        </thead>
                                        <tbody id="products-table-body">
                                        <!-- Products will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Edit Category Modal -->
<div class="modal fade" id="editCategoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Kategoriyani tahrirlash</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="edit-category-form">
                    <input type="hidden" id="edit-category-id">
                    <div class="mb-3">
                        <label class="form-label">Kategoriya nomi</label>
                        <input type="text" class="form-control" id="edit-category-name" required>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="edit-category-active">
                            <label class="form-check-label" for="edit-category-active">
                                Faol
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Bekor qilish</button>
                <button type="button" class="btn btn-custom" onclick="updateCategory()">Saqlash</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Product Modal -->
<div class="modal fade" id="editProductModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Mahsulotni tahrirlash</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="edit-product-form">
                    <input type="hidden" id="edit-product-id">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Mahsulot nomi *</label>
                            <input type="text" class="form-control" id="edit-product-name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Kategoriya *</label>
                            <select class="form-select" id="edit-product-category" required>
                                <option value="">Kategoriyani tanlang</option>
                                <!-- Categories will be loaded here -->
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tavsif</label>
                        <textarea class="form-control" id="edit-product-description" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Narx (So'm) *</label>
                            <input type="number" class="form-control" id="edit-product-price" step="0.01" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Miqdor *</label>
                            <input type="number" class="form-control" id="edit-product-amount" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Mavjud rasmlar</label>
                        <div class="uploaded-files" id="edit-product-current-images"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Yangi rasmlar qo'shish</label>
                        <div class="file-upload-area" id="edit-product-upload-area">
                            <i class="fas fa-cloud-upload-alt fa-2x mb-3"></i>
                            <p>Rasmlarni yuklash uchun bosing yoki shu yerga tashlang</p>
                            <input type="file" id="edit-product-file-input" accept="image/*" multiple style="display: none;">
                        </div>
                        <div class="uploaded-files" id="edit-product-uploaded-files"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Bekor qilish</button>
                <button type="button" class="btn btn-custom" onclick="updateProduct()">Saqlash</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // ======================================================
    // API CONFIGURATION
    // ======================================================
    const API_BASE_URL = 'http://16.171.152.61';

    // Create axios instance
    const api = axios.create({
        baseURL: API_BASE_URL,
        timeout: 15000,
        headers: {
            'Content-Type': 'application/json'
        }
    });

    // ======================================================
    // TOKEN MANAGEMENT
    // ======================================================
    function getCleanToken() {
        // Get token from localStorage and clean it
        let token = localStorage.getItem('accessToken') || localStorage.getItem('token');
        if (token) {
            // Remove any whitespace, newlines, or other unwanted characters
            token = token.trim().replace(/\s+/g, '');
            // Validate JWT format (should have 3 parts separated by dots)
            const parts = token.split('.');
            if (parts.length === 3) {
                return token;
            } else {
                console.error('Invalid JWT format:', token);
                return null;
            }
        }
        return null;
    }

    let accessToken = getCleanToken();
    let refreshToken = localStorage.getItem('refreshToken');
    if (refreshToken) {
        refreshToken = refreshToken.trim().replace(/\s+/g, '');
    }

    // Add token to all requests
    api.interceptors.request.use(
        (config) => {
            const cleanToken = getCleanToken();
            if (cleanToken) {
                config.headers.Authorization = `Bearer ${cleanToken}`;
                console.log('Adding token to request:', cleanToken.substring(0, 20) + '...');
            } else {
                console.warn('No valid token found for request');
            }
            return config;
        },
        (error) => {
            console.error('Request interceptor error:', error);
            return Promise.reject(error);
        }
    );

    // Handle token refresh and authentication errors
    api.interceptors.response.use(
        (response) => response,
        async (error) => {
            const originalRequest = error.config;

            if (error.response?.status === 401 && !originalRequest._retry) {
                originalRequest._retry = true;

                if (refreshToken) {
                    try {
                        console.log('Attempting token refresh...');
                        const response = await axios.post(`${API_BASE_URL}/api/v1/auth/refresh`, {
                            refreshToken: refreshToken.trim()
                        });

                        const newAccessToken = response.data.accessToken || response.data.token;
                        if (newAccessToken) {
                            const cleanNewToken = newAccessToken.trim().replace(/\s+/g, '');
                            accessToken = cleanNewToken;
                            localStorage.setItem('accessToken', cleanNewToken);
                            localStorage.setItem('token', cleanNewToken);

                            console.log('Token refreshed successfully');

                            // Retry original request with new token
                            originalRequest.headers.Authorization = `Bearer ${cleanNewToken}`;
                            return axios.request(originalRequest);
                        }
                    } catch (refreshError) {
                        console.error('Token refresh failed:', refreshError);
                        handleAuthenticationFailure();
                        return Promise.reject(refreshError);
                    }
                } else {
                    handleAuthenticationFailure();
                }
            }

            return Promise.reject(error);
        }
    );

    function handleAuthenticationFailure() {
        console.log('Authentication failed, redirecting to login...');
        localStorage.removeItem('accessToken');
        localStorage.removeItem('refreshToken');
        localStorage.removeItem('token');
        showNotification('error', 'Xatolik', 'Sessiya tugadi. Iltimos, qayta kiring.');
        setTimeout(() => {
            window.location.href = 'login.html';
        }, 2000);
    }

    // ======================================================
    // GLOBAL VARIABLES
    // ======================================================
    let allCategories = [];
    let allProducts = [];
    let allUsers = [];
    let uploadedCategoryFiles = [];
    let uploadedProductFiles = [];
    let editProductFiles = [];
    let currentProductImages = [];

    // ======================================================
    // INITIALIZATION
    // ======================================================
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Admin panel initializing...');

        if (!checkAuthentication()) {
            return;
        }

        initializeFileUploads();
        initializeForms();
        initializeTabListeners();
        loadDashboardData();
    });

    // ======================================================
    // TAB LISTENERS
    // ======================================================
    function initializeTabListeners() {
        // Add event listeners for tab changes
        const categoriesTab = document.getElementById('categories-tab');
        const productsTab = document.getElementById('products-tab');

        if (categoriesTab) {
            categoriesTab.addEventListener('click', function() {
                console.log('Categories tab clicked, loading categories...');
                setTimeout(() => loadCategories(), 100);
            });
        }

        if (productsTab) {
            productsTab.addEventListener('click', function() {
                console.log('Products tab clicked, loading data...');
                setTimeout(() => {
                    loadCategories(); // Load categories for dropdown
                    loadProducts();
                }, 100);
            });
        }
    }

    // ======================================================
    // AUTHENTICATION
    // ======================================================
    function checkAuthentication() {
        console.log('Checking authentication...');
        const cleanToken = getCleanToken();
        console.log('Clean token:', cleanToken ? 'Present' : 'Missing');

        if (!cleanToken) {
            console.log('No valid access token found, redirecting to login...');
            window.location.href = 'login.html';
            return false;
        }
        return true;
    }

    // ======================================================
    // FILE UPLOAD FUNCTIONALITY
    // ======================================================
    function initializeFileUploads() {
        // Category file upload
        const categoryUploadArea = document.getElementById('category-upload-area');
        const categoryFileInput = document.getElementById('category-file-input');

        if (categoryUploadArea && categoryFileInput) {
            categoryUploadArea.addEventListener('click', () => categoryFileInput.click());
            categoryUploadArea.addEventListener('dragover', handleDragOver);
            categoryUploadArea.addEventListener('drop', (e) => handleDrop(e, 'category'));
            categoryFileInput.addEventListener('change', (e) => handleFileSelect(e, 'category'));
        }

        // Product file upload
        const productUploadArea = document.getElementById('product-upload-area');
        const productFileInput = document.getElementById('product-file-input');

        if (productUploadArea && productFileInput) {
            productUploadArea.addEventListener('click', () => productFileInput.click());
            productUploadArea.addEventListener('dragover', handleDragOver);
            productUploadArea.addEventListener('drop', (e) => handleDrop(e, 'product'));
            productFileInput.addEventListener('change', (e) => handleFileSelect(e, 'product'));
        }

        // Edit product file upload
        const editProductUploadArea = document.getElementById('edit-product-upload-area');
        const editProductFileInput = document.getElementById('edit-product-file-input');

        if (editProductUploadArea && editProductFileInput) {
            editProductUploadArea.addEventListener('click', () => editProductFileInput.click());
            editProductUploadArea.addEventListener('dragover', handleDragOver);
            editProductUploadArea.addEventListener('drop', (e) => handleDrop(e, 'edit-product'));
            editProductFileInput.addEventListener('change', (e) => handleFileSelect(e, 'edit-product'));
        }
    }

    function handleDragOver(e) {
        e.preventDefault();
        e.currentTarget.classList.add('dragover');
    }

    function handleDrop(e, type) {
        e.preventDefault();
        e.currentTarget.classList.remove('dragover');
        const files = e.dataTransfer.files;
        processFiles(files, type);
    }

    function handleFileSelect(e, type) {
        const files = e.target.files;
        processFiles(files, type);
    }

    async function processFiles(files, type) {
        const maxFiles = type === 'category' ? 1 : 10;
        let currentFiles;

        if (type === 'category') {
            currentFiles = uploadedCategoryFiles;
        } else if (type === 'product') {
            currentFiles = uploadedProductFiles;
        } else if (type === 'edit-product') {
            currentFiles = editProductFiles;
        }

        if (currentFiles.length + files.length > maxFiles) {
            showNotification('error', 'Xatolik', `Maksimal ${maxFiles} ta fayl yuklash mumkin`);
            return;
        }

        for (let file of files) {
            if (!file.type.startsWith('image/')) {
                showNotification('error', 'Xatolik', 'Faqat rasm fayllarini yuklash mumkin');
                continue;
            }

            if (file.size > 5 * 1024 * 1024) {
                showNotification('error', 'Xatolik', 'Fayl hajmi 5MB dan oshmasligi kerak');
                continue;
            }

            try {
                const attachments = await uploadFile([file]);
                if (attachments && attachments.length > 0) {
                    if (type === 'category') {
                        uploadedCategoryFiles = attachments;
                        displayUploadedFiles('category');
                    } else if (type === 'product') {
                        uploadedProductFiles.push(...attachments);
                        displayUploadedFiles('product');
                    } else if (type === 'edit-product') {
                        editProductFiles.push(...attachments);
                        displayUploadedFiles('edit-product');
                    }
                    showNotification('success', 'Muvaffaqiyat', 'Fayl muvaffaqiyatli yuklandi');
                }
            } catch (error) {
                console.error('File upload error:', error);
                showNotification('error', 'Xatolik', 'Fayl yuklashda xatolik yuz berdi');
            }
        }
    }

    async function uploadFile(files) {
        const formData = new FormData();
        files.forEach(file => {
            formData.append('file', file);
        });

        try {
            const response = await api.post('/api/v1/attachment', formData, {
                headers: {
                    'Content-Type': 'multipart/form-data'
                }
            });

            console.log('File upload response:', response.data);

            // Handle different response formats
            if (Array.isArray(response.data)) {
                return response.data;
            } else if (response.data && response.data.id) {
                return [response.data];
            } else {
                throw new Error('Invalid response format');
            }
        } catch (error) {
            console.error('Upload API error:', error);
            throw new Error('File upload failed');
        }
    }

    function displayUploadedFiles(type) {
        let container;
        let files;

        if (type === 'category') {
            container = document.getElementById('category-uploaded-files');
            files = uploadedCategoryFiles;
        } else if (type === 'product') {
            container = document.getElementById('product-uploaded-files');
            files = uploadedProductFiles;
        } else if (type === 'edit-product') {
            container = document.getElementById('edit-product-uploaded-files');
            files = editProductFiles;
        }

        if (container) {
            container.innerHTML = files.map((file, index) => `
                <div class="uploaded-file">
                    <img src="${API_BASE_URL}/api/v1/attachment/${file.id}" alt="Uploaded file">
                    <button type="button" class="remove-file" onclick="removeUploadedFile('${type}', ${index})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }
    }

    function displayCurrentProductImages() {
        const container = document.getElementById('edit-product-current-images');

        if (container) {
            if (currentProductImages.length === 0) {
                container.innerHTML = '<p class="text-muted">Rasmlar mavjud emas</p>';
                return;
            }

            container.innerHTML = currentProductImages.map((image, index) => `
                <div class="uploaded-file">
                    <img src="${API_BASE_URL}/api/v1/attachment/${image.id}" alt="Current image">
                    <button type="button" class="remove-file" onclick="removeCurrentImage(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }
    }

    function removeUploadedFile(type, index) {
        if (type === 'category') {
            uploadedCategoryFiles.splice(index, 1);
            displayUploadedFiles('category');
        } else if (type === 'product') {
            uploadedProductFiles.splice(index, 1);
            displayUploadedFiles('product');
        } else if (type === 'edit-product') {
            editProductFiles.splice(index, 1);
            displayUploadedFiles('edit-product');
        }
    }

    function removeCurrentImage(index) {
        currentProductImages.splice(index, 1);
        displayCurrentProductImages();
    }

    // ======================================================
    // FORM INITIALIZATION
    // ======================================================
    function initializeForms() {
        const categoryForm = document.getElementById('category-form');
        const productForm = document.getElementById('product-form');

        if (categoryForm) {
            categoryForm.addEventListener('submit', handleCategorySubmit);
        }

        if (productForm) {
            productForm.addEventListener('submit', handleProductSubmit);
        }
    }

    async function handleCategorySubmit(e) {
        e.preventDefault();

        const name = document.getElementById('category-name').value;
        const active = document.getElementById('category-active').checked;
        const submitBtn = document.getElementById('category-submit-btn');

        if (!name.trim()) {
            showNotification('error', 'Xatolik', 'Kategoriya nomini kiriting');
            return;
        }

        try {
            // Show loading state
            setButtonLoading(submitBtn, true);

            const categoryData = {
                name: name.trim(),
                active: active,
                attachmentId: uploadedCategoryFiles.length > 0 ? uploadedCategoryFiles[0].id : null
            };

            console.log('Sending category data:', categoryData);

            const response = await api.post('/api/v1/category', categoryData);

            console.log('Category creation response:', response.data);

            showNotification('success', 'Muvaffaqiyat', 'Kategoriya muvaffaqiyatli qo\'shildi');

            // Reset form
            document.getElementById('category-form').reset();
            document.getElementById('category-active').checked = true;
            uploadedCategoryFiles = [];
            displayUploadedFiles('category');

            // Reload data
            await loadCategories();
            await loadDashboardData();

        } catch (error) {
            console.error('Category creation error:', error);
            console.error('Error response:', error.response?.data);

            let message = 'Kategoriya qo\'shishda xatolik yuz berdi';
            if (error.response?.data?.message) {
                message = error.response.data.message;
            } else if (error.response?.status === 400) {
                message = 'Noto\'g\'ri ma\'lumotlar yuborildi';
            } else if (error.response?.status === 401) {
                message = 'Ruxsat berilmagan. Qayta kiring.';
            } else if (error.response?.status === 500) {
                message = 'Server xatoligi. Iltimos, qayta urinib ko\'ring.';
            }

            showNotification('error', 'Xatolik', message);
        } finally {
            setButtonLoading(submitBtn, false);
        }
    }

    async function updateProduct() {
        const id = document.getElementById('edit-product-id').value;
        const name = document.getElementById('edit-product-name').value;
        const description = document.getElementById('edit-product-description').value;
        const price = parseFloat(document.getElementById('edit-product-price').value);
        const amount = parseInt(document.getElementById('edit-product-amount').value);
        const categoryId = parseInt(document.getElementById('edit-product-category').value);

        if (!name.trim() || !price || !amount || !categoryId) {
            showNotification('error', 'Xatolik', 'Barcha majburiy maydonlarni to\'ldiring');
            return;
        }

        try {
            // Combine current images and newly uploaded images
            const allAttachmentIds = [
                ...currentProductImages.map(img => img.id),
                ...editProductFiles.map(file => file.id)
            ];

            const productData = {
                name: name.trim(),
                description: description.trim(),
                price: price,
                amount: amount,
                categoryId: categoryId,
                attachmentIds: allAttachmentIds
            };

            console.log('Updating product:', productData);

            await api.put(`/api/products/admin/${id}`, productData);

            showNotification('success', 'Muvaffaqiyat', 'Mahsulot muvaffaqiyatli yangilandi');
            bootstrap.Modal.getInstance(document.getElementById('editProductModal')).hide();

            // Reset edit form data
            editProductFiles = [];
            currentProductImages = [];

            // Reload products
            await loadProducts();
            await loadDashboardData();
        } catch (error) {
            console.error('Product update error:', error);
            const message = error.response?.data?.message || 'Mahsulotni yangilashda xatolik yuz berdi';
            showNotification('error', 'Xatolik', message);
        }
    }

    function setButtonLoading(button, loading) {
        if (loading) {
            button.disabled = true;
            const originalText = button.innerHTML;
            button.setAttribute('data-original-text', originalText);
            button.innerHTML = '<span class="loading-spinner"></span>Yuklanmoqda...';
        } else {
            button.disabled = false;
            const originalText = button.getAttribute('data-original-text');
            if (originalText) {
                button.innerHTML = originalText;
            }
        }
    }

    // ======================================================
    // DATA LOADING FUNCTIONS
    // ======================================================
    async function loadDashboardData() {
        console.log('Loading dashboard data...');
        try {
            // Load data in parallel but handle errors individually
            const results = await Promise.allSettled([
                loadCategories(),
                loadProducts(),
                loadUsers()
            ]);

            // Check if any failed
            results.forEach((result, index) => {
                if (result.status === 'rejected') {
                    console.error(`Failed to load data ${index}:`, result.reason);
                }
            });

            updateDashboardStats();
        } catch (error) {
            console.error('Dashboard loading error:', error);
            showNotification('error', 'Xatolik', 'Dashboard ma\'lumotlarini yuklashda xatolik');
        }
    }

    function updateDashboardStats() {
        // Update stats
        document.getElementById('total-categories').textContent = allCategories.length;
        document.getElementById('total-products').textContent = allProducts.length;
        document.getElementById('total-users').textContent = allUsers.length;
        document.getElementById('low-stock-products').textContent = allProducts.filter(p => p.amount < 5).length;

        // Display recent categories
        const recentCategories = allCategories.slice(-5).reverse();
        const recentCategoriesContainer = document.getElementById('recent-categories');
        if (recentCategoriesContainer) {
            recentCategoriesContainer.innerHTML = recentCategories.length > 0 ?
                recentCategories.map(cat => `
                    <div class="d-flex align-items-center mb-3 p-3 bg-light rounded-3 fade-in">
                        <div class="me-3">
                            <i class="fas fa-tag fs-4 text-primary"></i>
                        </div>
                        <div>
                            <div class="fw-bold">${cat.name}</div>
                            <small class="text-muted">ID: ${cat.id}</small>
                        </div>
                    </div>
                `).join('') : '<p class="text-muted">Kategoriyalar mavjud emas</p>';
        }

        // Display recent products
        const recentProducts = allProducts.slice(-5).reverse();
        const recentProductsContainer = document.getElementById('recent-products');
        if (recentProductsContainer) {
            recentProductsContainer.innerHTML = recentProducts.length > 0 ?
                recentProducts.map(prod => `
                    <div class="d-flex align-items-center mb-3 p-3 bg-light rounded-3 fade-in">
                        <div class="me-3">
                            ${prod.attachments && prod.attachments.length > 0 ?
                    `<img src="${API_BASE_URL}/api/v1/attachment/${prod.attachments[0].id}" class="rounded-3" width="50" height="50" style="object-fit: cover;">` :
                    `<i class="fas fa-box fs-4 text-success"></i>`
                }
                        </div>
                        <div class="flex-grow-1">
                            <div class="fw-bold">${prod.name}</div>
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-primary fw-bold">${formatPrice(prod.price)} So'm</small>
                                <span class="badge bg-${prod.amount < 5 ? 'danger' : 'success'}">${prod.amount} dona</span>
                            </div>
                        </div>
                    </div>
                `).join('') : '<p class="text-muted">Mahsulotlar mavjud emas</p>';
        }
    }

    async function loadCategories() {
        const loading = document.getElementById('categories-loading');
        const tableBody = document.getElementById('categories-table-body');
        const categorySelect = document.getElementById('product-category');
        const editCategorySelect = document.getElementById('edit-product-category');

        try {
            if (loading) loading.classList.add('show');

            console.log('Loading categories...');
            const response = await api.get('/api/v1/category/all-active');
            allCategories = response.data || [];

            console.log('Categories loaded:', allCategories);

            // Update table
            if (tableBody) {
                tableBody.innerHTML = allCategories.length > 0 ?
                    allCategories.map(category => {
                        // Handle both 'active' and '_active' field names
                        const isActive = category.active !== undefined ? category.active : category._active;
                        return `
                            <tr class="fade-in">
                                <td>${category.id}</td>
                                <td>
                                    ${category.attachment ?
                            `<img src="${API_BASE_URL}/api/v1/attachment/${category.attachment.id}" class="image-preview" alt="${category.name}">` :
                            '<i class="fas fa-image text-muted"></i>'
                        }
                                </td>
                                <td>${category.name}</td>
                                <td>
                                    <span class="badge-custom ${isActive ? '' : 'badge-inactive'}">
                                        ${isActive ? 'Faol' : 'Nofaol'}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-outline-custom btn-sm me-2" onclick="editCategory(${category.id})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="deleteCategory(${category.id})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('') : '<tr><td colspan="5" class="text-center">Kategoriyalar mavjud emas</td></tr>';
            }

            // Update category selects in product forms
            updateCategorySelect(categorySelect);
            updateCategorySelect(editCategorySelect);

            if (loading) loading.classList.remove('show');
        } catch (error) {
            console.error('Categories loading error:', error);
            if (loading) {
                loading.innerHTML = '<p class="text-danger">Kategoriyalarni yuklashda xatolik yuz berdi</p>';
            }
            if (tableBody) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Kategoriyalarni yuklashda xatolik yuz berdi</td></tr>';
            }
            throw error;
        }
    }

    function updateCategorySelect(selectElement) {
        if (!selectElement) return;

        console.log('Updating category select with', allCategories.length, 'categories');

        // Filter active categories - handle both 'active' and '_active' field names
        const activeCategories = allCategories.filter(cat =>
            (cat.active !== undefined ? cat.active : cat._active)
        );

        console.log('Active categories:', activeCategories.length);

        // Clear existing options
        selectElement.innerHTML = '<option value="">Kategoriyani tanlang</option>';

        // Add new options
        if (activeCategories.length > 0) {
            activeCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                selectElement.appendChild(option);
            });
        } else {
            // Add a disabled option if no categories
            const option = document.createElement('option');
            option.disabled = true;
            option.textContent = 'Faol kategoriyalar mavjud emas';
            selectElement.appendChild(option);
        }
    }

    async function loadProducts() {
        const loading = document.getElementById('products-loading');
        const tableBody = document.getElementById('products-table-body');

        try {
            if (loading) loading.classList.add('show');

            console.log('Loading products...');
            const response = await api.get('/api/products/admin');
            allProducts = response.data || [];

            console.log('Products loaded:', allProducts);

            if (tableBody) {
                tableBody.innerHTML = allProducts.length > 0 ?
                    allProducts.map(product => {
                        // Handle different attachment field names
                        const attachments = product.attachments || product.attachmentIds || [];
                        const firstAttachment = attachments.length > 0 ? attachments[0] : null;

                        // Find category name
                        const category = allCategories.find(c => c.id === product.categoryId);
                        const categoryName = category ? category.name : 'N/A';

                        return `
                            <tr class="fade-in">
                                <td>${product.id}</td>
                                <td>
                                    ${firstAttachment ?
                            `<img src="${API_BASE_URL}/api/v1/attachment/${firstAttachment.id}" class="image-preview" alt="${product.name}">` :
                            '<i class="fas fa-image text-muted"></i>'
                        }
                                </td>
                                <td>${product.name}</td>
                                <td>${formatPrice(product.price)} So'm</td>
                                <td>
                                    <span class="badge-custom ${product.amount < 5 ? 'badge-inactive' : ''}">
                                        ${product.amount}
                                    </span>
                                </td>
                                <td>${categoryName}</td>
                                <td>
                                    <button class="btn btn-outline-custom btn-sm me-2" onclick="editProduct(${product.id})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="deleteProduct(${product.id})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('') : '<tr><td colspan="7" class="text-center">Mahsulotlar mavjud emas</td></tr>';
            }

            if (loading) loading.classList.remove('show');
        } catch (error) {
            console.error('Products loading error:', error);
            if (loading) {
                loading.innerHTML = '<p class="text-danger">Mahsulotlarni yuklashda xatolik yuz berdi</p>';
            }
            if (tableBody) {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Mahsulotlarni yuklashda xatolik yuz berdi</td></tr>';
            }
            throw error;
        }
    }

    async function loadUsers() {
        try {
            console.log('Loading users...');
            const response = await api.get('/api/user/admin');
            allUsers = response.data || [];
            console.log('Users loaded:', allUsers);
        } catch (error) {
            console.error('Users loading error:', error);
            allUsers = [];
            throw error;
        }
    }

    // ======================================================
    // CRUD OPERATIONS
    // ======================================================
    function editCategory(categoryId) {
        const category = allCategories.find(cat => cat.id === categoryId);
        if (!category) return;

        document.getElementById('edit-category-id').value = category.id;
        document.getElementById('edit-category-name').value = category.name;

        // Handle both 'active' and '_active' field names
        const isActive = category.active !== undefined ? category.active : category._active;
        document.getElementById('edit-category-active').checked = isActive;

        const modal = new bootstrap.Modal(document.getElementById('editCategoryModal'));
        modal.show();
    }

    function editProduct(productId) {
        const product = allProducts.find(p => p.id === productId);
        if (!product) return;

        // Reset edit form data
        editProductFiles = [];
        currentProductImages = product.attachments || [];

        // Fill form fields
        document.getElementById('edit-product-id').value = product.id;
        document.getElementById('edit-product-name').value = product.name;
        document.getElementById('edit-product-description').value = product.description || '';
        document.getElementById('edit-product-price').value = product.price;
        document.getElementById('edit-product-amount').value = product.amount;

        // Set category
        const categorySelect = document.getElementById('edit-product-category');
        if (categorySelect) {
            for (let i = 0; i < categorySelect.options.length; i++) {
                if (categorySelect.options[i].value == product.categoryId) {
                    categorySelect.selectedIndex = i;
                    break;
                }
            }
        }

        // Display current images
        displayCurrentProductImages();
        displayUploadedFiles('edit-product');

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('editProductModal'));
        modal.show();
    }

    async function updateCategory() {
        const id = document.getElementById('edit-category-id').value;
        const name = document.getElementById('edit-category-name').value;
        const active = document.getElementById('edit-category-active').checked;

        try {
            const updateData = {
                name: name.trim(),
                active: active
            };

            console.log('Updating category:', updateData);

            await api.post(`/api/v1/category/${id}`, updateData);

            showNotification('success', 'Muvaffaqiyat', 'Kategoriya muvaffaqiyatli yangilandi');
            bootstrap.Modal.getInstance(document.getElementById('editCategoryModal')).hide();
            await loadCategories();
            await loadDashboardData();
        } catch (error) {
            console.error('Category update error:', error);
            const message = error.response?.data?.message || 'Kategoriyani yangilashda xatolik yuz berdi';
            showNotification('error', 'Xatolik', message);
        }
    }

    async function deleteCategory(categoryId) {
        if (!confirm('Kategoriyani o\'chirishni xohlaysizmi?')) return;

        try {
            console.log('Deleting category:', categoryId);
            await api.delete(`/api/v1/category/${categoryId}`);
            showNotification('success', 'Muvaffaqiyat', 'Kategoriya muvaffaqiyatli o\'chirildi');
            await loadCategories();
            await loadDashboardData();
        } catch (error) {
            console.error('Category delete error:', error);
            const message = error.response?.data?.message || 'Kategoriyani o\'chirishda xatolik yuz berdi';
            showNotification('error', 'Xatolik', message);
        }
    }

    async function deleteProduct(productId) {
        if (!confirm('Mahsulotni o\'chirishni xohlaysizmi?')) return;

        try {
            console.log('Deleting product:', productId);
            await api.delete(`/api/products/admin/${productId}`);
            showNotification('success', 'Muvaffaqiyat', 'Mahsulot muvaffaqiyatli o\'chirildi');
            await loadProducts();
            await loadDashboardData();
        } catch (error) {
            console.error('Product delete error:', error);
            const message = error.response?.data?.message || 'Mahsulotni o\'chirishda xatolik yuz berdi';
            showNotification('error', 'Xatolik', message);
        }
    }

    // ======================================================
    // UTILITY FUNCTIONS
    // ======================================================
    function formatPrice(price) {
        return new Intl.NumberFormat('uz-UZ').format(price);
    }

    function goToMainSite() {
        window.location.href = 'index.html';
    }

    function logout() {
        console.log('Logging out...');
        localStorage.removeItem('accessToken');
        localStorage.removeItem('refreshToken');
        localStorage.removeItem('token');
        showNotification('success', 'Chiqish', 'Muvaffaqiyatli chiqildi');
        setTimeout(() => {
            window.location.href = 'login.html';
        }, 1000);
    }

    function showNotification(type, title, message) {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 350px;';

        notification.innerHTML = `
            <strong>${title}:</strong> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;

        document.body.appendChild(notification);

        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 6000);
    }
</script>
</body>
</html>