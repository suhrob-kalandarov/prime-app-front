<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Just Online Store</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        :root {
            --primary-color: #232526;
            --secondary-color: #3b3f41;
            --accent-color: #f8f9fb;
            --text-color: #232526;
            --light-color: #ffffff;
            --border-color: #e9ecef;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --transition: all 0.3s ease;
            --border-radius: 10px;
            --box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #f8f9fa;
            color: var(--text-color);
        }

        .admin-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: var(--light-color);
            padding: 20px 0;
            box-shadow: var(--box-shadow);
        }

        .admin-title {
            font-size: 2rem;
            font-weight: 700;
            margin: 0;
        }

        .admin-subtitle {
            opacity: 0.8;
            margin: 0;
        }

        .admin-nav {
            background: var(--light-color);
            padding: 15px 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 0;
            z-index: 1020;
        }

        .nav-tabs .nav-link {
            border: none;
            color: var(--text-color);
            font-weight: 500;
            padding: 12px 20px;
            border-radius: 25px;
            margin-right: 10px;
            transition: var(--transition);
        }

        .nav-tabs .nav-link:hover {
            background-color: var(--accent-color);
            color: var(--primary-color);
        }

        .nav-tabs .nav-link.active {
            background-color: var(--primary-color);
            color: var(--light-color);
        }

        .admin-content {
            padding: 30px 0;
        }

        .card {
            border: none;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 30px;
        }

        .card-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: var(--light-color);
            border: none;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            padding: 20px;
        }

        .card-title {
            margin: 0;
            font-weight: 600;
        }

        .btn-custom {
            background-color: var(--primary-color);
            color: var(--light-color);
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 500;
            transition: var(--transition);
        }

        .btn-custom:hover {
            background-color: var(--secondary-color);
            color: var(--light-color);
            transform: translateY(-2px);
        }

        .btn-custom:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-outline-custom {
            background-color: transparent;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 500;
            transition: var(--transition);
        }

        .btn-outline-custom:hover {
            background-color: var(--primary-color);
            color: var(--light-color);
        }

        .form-control, .form-select {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px 15px;
            transition: var(--transition);
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(35, 37, 38, 0.1);
        }

        .table {
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        .table thead th {
            background-color: var(--accent-color);
            border: none;
            font-weight: 600;
            color: var(--text-color);
        }

        .table tbody tr {
            transition: var(--transition);
        }

        .table tbody tr:hover {
            background-color: rgba(35, 37, 38, 0.05);
        }

        .badge-custom {
            background-color: var(--success-color);
            color: var(--light-color);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
        }

        .badge-inactive {
            background-color: var(--danger-color);
        }

        .image-preview {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid var(--border-color);
        }

        .file-upload-area {
            border: 2px dashed var(--border-color);
            border-radius: var(--border-radius);
            padding: 40px;
            text-align: center;
            transition: var(--transition);
            cursor: pointer;
        }

        .file-upload-area:hover {
            border-color: var(--primary-color);
            background-color: rgba(35, 37, 38, 0.05);
        }

        .file-upload-area.dragover {
            border-color: var(--primary-color);
            background-color: rgba(35, 37, 38, 0.1);
        }

        .uploaded-files {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .uploaded-file {
            position: relative;
            display: inline-block;
        }

        .uploaded-file img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid var(--border-color);
        }

        .remove-file {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
        }

        .stats-card {
            background: linear-gradient(135deg, var(--info-color), #20c997);
            color: var(--light-color);
            border-radius: var(--border-radius);
            padding: 25px;
            text-align: center;
            margin-bottom: 20px;
        }

        .stats-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .stats-label {
            font-size: 1rem;
            opacity: 0.9;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .modal-content {
            border-radius: var(--border-radius);
            border: none;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: var(--light-color);
            border: none;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid var(--light-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @media (max-width: 768px) {
            .admin-title {
                font-size: 1.5rem;
            }

            .table-responsive {
                font-size: 14px;
            }

            .uploaded-files {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
<!-- Admin Header -->
<div class="admin-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h1 class="admin-title">Admin Panel</h1>
                <p class="admin-subtitle">Just Online Store boshqaruv paneli</p>
            </div>
            <div class="col-md-6 text-md-end">
                <button class="btn btn-light me-2" onclick="goToMainSite()">
                    <i class="fas fa-home me-2"></i>Asosiy saytga o'tish
                </button>
                <button class="btn btn-outline-light" onclick="logout()">
                    <i class="fas fa-sign-out-alt me-2"></i>Chiqish
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Admin Navigation -->
<div class="admin-nav">
    <div class="container">
        <ul class="nav nav-tabs" id="adminTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab">
                    <i class="fas fa-chart-bar me-2"></i>Dashboard
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="categories-tab" data-bs-toggle="tab" data-bs-target="#categories" type="button" role="tab">
                    <i class="fas fa-tags me-2"></i>Kategoriyalar
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="products-tab" data-bs-toggle="tab" data-bs-target="#products" type="button" role="tab">
                    <i class="fas fa-box me-2"></i>Mahsulotlar
                </button>
            </li>
        </ul>
    </div>
</div>

<!-- Admin Content -->
<div class="admin-content">
    <div class="container">
        <div class="tab-content" id="adminTabsContent">

            <!-- Dashboard Tab -->
            <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
                <div class="row">
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="stats-card">
                            <div class="stats-number" id="total-categories">0</div>
                            <div class="stats-label">Kategoriyalar</div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="stats-card" style="background: linear-gradient(135deg, var(--success-color), #20c997);">
                            <div class="stats-number" id="total-products">0</div>
                            <div class="stats-label">Mahsulotlar</div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="stats-card" style="background: linear-gradient(135deg, var(--warning-color), #fd7e14);">
                            <div class="stats-number" id="low-stock-products">0</div>
                            <div class="stats-label">Kam qolgan</div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="stats-card" style="background: linear-gradient(135deg, var(--info-color), #6f42c1);">
                            <div class="stats-number" id="total-users">0</div>
                            <div class="stats-label">Foydalanuvchilar</div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-lg-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title">So'nggi qo'shilgan kategoriyalar</h5>
                            </div>
                            <div class="card-body">
                                <div id="recent-categories">
                                    <div class="loading show">
                                        <div class="spinner"></div>
                                        <p>Yuklanmoqda...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title">So'nggi qo'shilgan mahsulotlar</h5>
                            </div>
                            <div class="card-body">
                                <div id="recent-products">
                                    <div class="loading show">
                                        <div class="spinner"></div>
                                        <p>Yuklanmoqda...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Categories Tab -->
            <div class="tab-pane fade" id="categories" role="tabpanel">
                <div class="row">
                    <div class="col-lg-4 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title">Kategoriya qo'shish</h5>
                            </div>
                            <div class="card-body">
                                <form id="category-form">
                                    <div class="mb-3">
                                        <label class="form-label">Kategoriya nomi *</label>
                                        <input type="text" class="form-control" id="category-name" required>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Rasm (ixtiyoriy)</label>
                                        <div class="file-upload-area" id="category-upload-area">
                                            <i class="fas fa-cloud-upload-alt fa-2x mb-3"></i>
                                            <p>Rasm yuklash uchun bosing yoki shu yerga tashlang</p>
                                            <input type="file" id="category-file-input" accept="image/*" style="display: none;">
                                        </div>
                                        <div class="uploaded-files" id="category-uploaded-files"></div>
                                    </div>

                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="category-active" checked>
                                            <label class="form-check-label" for="category-active">
                                                Faol
                                            </label>
                                        </div>
                                    </div>

                                    <button type="submit" class="btn btn-custom w-100" id="category-submit-btn">
                                        <i class="fas fa-plus me-2"></i>Kategoriya qo'shish
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-8 mb-4">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="card-title">Kategoriyalar ro'yxati</h5>
                                <button class="btn btn-outline-light btn-sm" onclick="loadCategories()">
                                    <i class="fas fa-sync-alt me-2"></i>Yangilash
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="loading" id="categories-loading">
                                    <div class="spinner"></div>
                                    <p>Yuklanmoqda...</p>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Rasm</th>
                                            <th>Nomi</th>
                                            <th>Holati</th>
                                            <th>Amallar</th>
                                        </tr>
                                        </thead>
                                        <tbody id="categories-table-body">
                                        <!-- Categories will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Products Tab -->
            <div class="tab-pane fade" id="products" role="tabpanel">
                <div class="row">
                    <div class="col-lg-4 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title">Mahsulot qo'shish</h5>
                            </div>
                            <div class="card-body">
                                <form id="product-form">
                                    <div class="mb-3">
                                        <label class="form-label">Mahsulot nomi *</label>
                                        <input type="text" class="form-control" id="product-name" required>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Tavsif</label>
                                        <textarea class="form-control" id="product-description" rows="3"></textarea>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Narx (So'm) *</label>
                                        <input type="number" class="form-control" id="product-price" step="0.01" required>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Miqdor *</label>
                                        <input type="number" class="form-control" id="product-amount" required>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Kategoriya *</label>
                                        <select class="form-select" id="product-category" required>
                                            <option value="">Kategoriyani tanlang</option>
                                            <!-- Categories will be loaded here -->
                                        </select>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Rasmlar (ixtiyoriy)</label>
                                        <div class="file-upload-area" id="product-upload-area">
                                            <i class="fas fa-cloud-upload-alt fa-2x mb-3"></i>
                                            <p>Rasmlarni yuklash uchun bosing yoki shu yerga tashlang</p>
                                            <input type="file" id="product-file-input" accept="image/*" multiple style="display: none;">
                                        </div>
                                        <div class="uploaded-files" id="product-uploaded-files"></div>
                                    </div>

                                    <button type="submit" class="btn btn-custom w-100" id="product-submit-btn">
                                        <i class="fas fa-plus me-2"></i>Mahsulot qo'shish
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-8 mb-4">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="card-title">Mahsulotlar ro'yxati</h5>
                                <button class="btn btn-outline-light btn-sm" onclick="loadProducts()">
                                    <i class="fas fa-sync-alt me-2"></i>Yangilash
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="loading" id="products-loading">
                                    <div class="spinner"></div>
                                    <p>Yuklanmoqda...</p>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Rasm</th>
                                            <th>Nomi</th>
                                            <th>Narx</th>
                                            <th>Miqdor</th>
                                            <th>Kategoriya</th>
                                            <th>Amallar</th>
                                        </tr>
                                        </thead>
                                        <tbody id="products-table-body">
                                        <!-- Products will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Edit Category Modal -->
<div class="modal fade" id="editCategoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Kategoriyani tahrirlash</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="edit-category-form">
                    <input type="hidden" id="edit-category-id">
                    <div class="mb-3">
                        <label class="form-label">Kategoriya nomi</label>
                        <input type="text" class="form-control" id="edit-category-name" required>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="edit-category-active">
                            <label class="form-check-label" for="edit-category-active">
                                Faol
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Bekor qilish</button>
                <button type="button" class="btn btn-custom" onclick="updateCategory()">Saqlash</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // ======================================================
    // API CONFIGURATION
    // ======================================================
    const API_BASE_URL = 'http://16.171.152.61';

    // Create axios instance
    const api = axios.create({
        baseURL: API_BASE_URL,
        timeout: 15000,
        headers: {
            'Content-Type': 'application/json'
        }
    });

    // ======================================================
    // TOKEN MANAGEMENT
    // ======================================================
    function getCleanToken() {
        // Get token from localStorage and clean it
        let token = localStorage.getItem('accessToken') || localStorage.getItem('token');
        if (token) {
            // Remove any whitespace, newlines, or other unwanted characters
            token = token.trim().replace(/\s+/g, '');
            // Validate JWT format (should have 3 parts separated by dots)
            const parts = token.split('.');
            if (parts.length === 3) {
                return token;
            } else {
                console.error('Invalid JWT format:', token);
                return null;
            }
        }
        return null;
    }

    let accessToken = getCleanToken();
    let refreshToken = localStorage.getItem('refreshToken');
    if (refreshToken) {
        refreshToken = refreshToken.trim().replace(/\s+/g, '');
    }

    // Add token to all requests
    api.interceptors.request.use(
        (config) => {
            const cleanToken = getCleanToken();
            if (cleanToken) {
                config.headers.Authorization = `Bearer ${cleanToken}`;
                console.log('Adding token to request:', cleanToken.substring(0, 20) + '...');
            } else {
                console.warn('No valid token found for request');
            }
            return config;
        },
        (error) => {
            console.error('Request interceptor error:', error);
            return Promise.reject(error);
        }
    );

    // Handle token refresh and authentication errors
    api.interceptors.response.use(
        (response) => response,
        async (error) => {
            const originalRequest = error.config;

            if (error.response?.status === 401 && !originalRequest._retry) {
                originalRequest._retry = true;

                if (refreshToken) {
                    try {
                        console.log('Attempting token refresh...');
                        const response = await axios.post(`${API_BASE_URL}/api/v1/auth/refresh`, {
                            refreshToken: refreshToken.trim()
                        });

                        const newAccessToken = response.data.accessToken || response.data.token;
                        if (newAccessToken) {
                            const cleanNewToken = newAccessToken.trim().replace(/\s+/g, '');
                            accessToken = cleanNewToken;
                            localStorage.setItem('accessToken', cleanNewToken);
                            localStorage.setItem('token', cleanNewToken);

                            console.log('Token refreshed successfully');

                            // Retry original request with new token
                            originalRequest.headers.Authorization = `Bearer ${cleanNewToken}`;
                            return axios.request(originalRequest);
                        }
                    } catch (refreshError) {
                        console.error('Token refresh failed:', refreshError);
                        handleAuthenticationFailure();
                        return Promise.reject(refreshError);
                    }
                } else {
                    handleAuthenticationFailure();
                }
            }

            return Promise.reject(error);
        }
    );

    function handleAuthenticationFailure() {
        console.log('Authentication failed, redirecting to login...');
        localStorage.removeItem('accessToken');
        localStorage.removeItem('refreshToken');
        localStorage.removeItem('token');
        showNotification('error', 'Xatolik', 'Sessiya tugadi. Iltimos, qayta kiring.');
        setTimeout(() => {
            window.location.href = 'login.html';
        }, 2000);
    }

    // ======================================================
    // GLOBAL VARIABLES
    // ======================================================
    let allCategories = [];
    let allProducts = [];
    let allUsers = [];
    let uploadedCategoryFiles = [];
    let uploadedProductFiles = [];

    // ======================================================
    // INITIALIZATION
    // ======================================================
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Admin panel initializing...');

        if (!checkAuthentication()) {
            return;
        }

        initializeFileUploads();
        initializeForms();
        initializeTabListeners();
        loadDashboardData();
    });

    // ======================================================
    // TAB LISTENERS
    // ======================================================
    function initializeTabListeners() {
        // Add event listeners for tab changes
        const categoriesTab = document.getElementById('categories-tab');
        const productsTab = document.getElementById('products-tab');

        if (categoriesTab) {
            categoriesTab.addEventListener('click', function() {
                console.log('Categories tab clicked, loading categories...');
                setTimeout(() => loadCategories(), 100);
            });
        }

        if (productsTab) {
            productsTab.addEventListener('click', function() {
                console.log('Products tab clicked, loading data...');
                setTimeout(() => {
                    loadCategories(); // Load categories for dropdown
                    loadProducts();
                }, 100);
            });
        }
    }

    // ======================================================
    // AUTHENTICATION
    // ======================================================
    function checkAuthentication() {
        console.log('Checking authentication...');
        const cleanToken = getCleanToken();
        console.log('Clean token:', cleanToken ? 'Present' : 'Missing');

        if (!cleanToken) {
            console.log('No valid access token found, redirecting to login...');
            window.location.href = 'login.html';
            return false;
        }
        return true;
    }

    // ======================================================
    // FILE UPLOAD FUNCTIONALITY
    // ======================================================
    function initializeFileUploads() {
        // Category file upload
        const categoryUploadArea = document.getElementById('category-upload-area');
        const categoryFileInput = document.getElementById('category-file-input');

        if (categoryUploadArea && categoryFileInput) {
            categoryUploadArea.addEventListener('click', () => categoryFileInput.click());
            categoryUploadArea.addEventListener('dragover', handleDragOver);
            categoryUploadArea.addEventListener('drop', (e) => handleDrop(e, 'category'));
            categoryFileInput.addEventListener('change', (e) => handleFileSelect(e, 'category'));
        }

        // Product file upload
        const productUploadArea = document.getElementById('product-upload-area');
        const productFileInput = document.getElementById('product-file-input');

        if (productUploadArea && productFileInput) {
            productUploadArea.addEventListener('click', () => productFileInput.click());
            productUploadArea.addEventListener('dragover', handleDragOver);
            productUploadArea.addEventListener('drop', (e) => handleDrop(e, 'product'));
            productFileInput.addEventListener('change', (e) => handleFileSelect(e, 'product'));
        }
    }

    function handleDragOver(e) {
        e.preventDefault();
        e.currentTarget.classList.add('dragover');
    }

    function handleDrop(e, type) {
        e.preventDefault();
        e.currentTarget.classList.remove('dragover');
        const files = e.dataTransfer.files;
        processFiles(files, type);
    }

    function handleFileSelect(e, type) {
        const files = e.target.files;
        processFiles(files, type);
    }

    async function processFiles(files, type) {
        const maxFiles = type === 'category' ? 1 : 10;
        const currentFiles = type === 'category' ? uploadedCategoryFiles : uploadedProductFiles;

        if (currentFiles.length + files.length > maxFiles) {
            showNotification('error', 'Xatolik', `Maksimal ${maxFiles} ta fayl yuklash mumkin`);
            return;
        }

        for (let file of files) {
            if (!file.type.startsWith('image/')) {
                showNotification('error', 'Xatolik', 'Faqat rasm fayllarini yuklash mumkin');
                continue;
            }

            if (file.size > 5 * 1024 * 1024) {
                showNotification('error', 'Xatolik', 'Fayl hajmi 5MB dan oshmasligi kerak');
                continue;
            }

            try {
                const attachments = await uploadFile([file]);
                if (attachments && attachments.length > 0) {
                    if (type === 'category') {
                        uploadedCategoryFiles = attachments;
                        displayUploadedFiles('category');
                    } else {
                        uploadedProductFiles.push(...attachments);
                        displayUploadedFiles('product');
                    }
                    showNotification('success', 'Muvaffaqiyat', 'Fayl muvaffaqiyatli yuklandi');
                }
            } catch (error) {
                console.error('File upload error:', error);
                showNotification('error', 'Xatolik', 'Fayl yuklashda xatolik yuz berdi');
            }
        }
    }

    async function uploadFile(files) {
        const formData = new FormData();
        files.forEach(file => {
            formData.append('file', file);
        });

        try {
            const response = await api.post('/api/v1/attachment', formData, {
                headers: {
                    'Content-Type': 'multipart/form-data'
                }
            });

            console.log('File upload response:', response.data);

            // Handle different response formats
            if (Array.isArray(response.data)) {
                return response.data;
            } else if (response.data && response.data.id) {
                return [response.data];
            } else {
                throw new Error('Invalid response format');
            }
        } catch (error) {
            console.error('Upload API error:', error);
            throw new Error('File upload failed');
        }
    }

    function displayUploadedFiles(type) {
        const container = document.getElementById(`${type}-uploaded-files`);
        const files = type === 'category' ? uploadedCategoryFiles : uploadedProductFiles;

        if (container) {
            container.innerHTML = files.map((file, index) => `
                    <div class="uploaded-file">
                        <img src="${API_BASE_URL}/api/v1/attachment/${file.id}" alt="Uploaded file">
                        <button type="button" class="remove-file" onclick="removeUploadedFile('${type}', ${index})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `).join('');
        }
    }

    function removeUploadedFile(type, index) {
        if (type === 'category') {
            uploadedCategoryFiles.splice(index, 1);
        } else {
            uploadedProductFiles.splice(index, 1);
        }
        displayUploadedFiles(type);
    }

    // ======================================================
    // FORM INITIALIZATION
    // ======================================================
    function initializeForms() {
        const categoryForm = document.getElementById('category-form');
        const productForm = document.getElementById('product-form');

        if (categoryForm) {
            categoryForm.addEventListener('submit', handleCategorySubmit);
        }

        if (productForm) {
            productForm.addEventListener('submit', handleProductSubmit);
        }
    }

    async function handleCategorySubmit(e) {
        e.preventDefault();

        const name = document.getElementById('category-name').value;
        const active = document.getElementById('category-active').checked;
        const submitBtn = document.getElementById('category-submit-btn');

        if (!name.trim()) {
            showNotification('error', 'Xatolik', 'Kategoriya nomini kiriting');
            return;
        }

        try {
            // Show loading state
            setButtonLoading(submitBtn, true);

            const categoryData = {
                name: name.trim(),
                active: active,
                attachmentId: uploadedCategoryFiles.length > 0 ? uploadedCategoryFiles[0].id : null
            };

            console.log('Sending category data:', categoryData);

            const response = await api.post('/api/v1/category', categoryData);

            console.log('Category creation response:', response.data);

            showNotification('success', 'Muvaffaqiyat', 'Kategoriya muvaffaqiyatli qo\'shildi');

            // Reset form
            document.getElementById('category-form').reset();
            document.getElementById('category-active').checked = true;
            uploadedCategoryFiles = [];
            displayUploadedFiles('category');

            // Reload data
            await loadCategories();
            await loadDashboardData();

        } catch (error) {
            console.error('Category creation error:', error);
            console.error('Error response:', error.response?.data);

            let message = 'Kategoriya qo\'shishda xatolik yuz berdi';
            if (error.response?.data?.message) {
                message = error.response.data.message;
            } else if (error.response?.status === 400) {
                message = 'Noto\'g\'ri ma\'lumotlar yuborildi';
            } else if (error.response?.status === 401) {
                message = 'Ruxsat berilmagan. Qayta kiring.';
            } else if (error.response?.status === 500) {
                message = 'Server xatoligi. Iltimos, qayta urinib ko\'ring.';
            }

            showNotification('error', 'Xatolik', message);
        } finally {
            setButtonLoading(submitBtn, false);
        }
    }

    async function handleProductSubmit(e) {
        e.preventDefault();

        const name = document.getElementById('product-name').value;
        const description = document.getElementById('product-description').value;
        const price = parseFloat(document.getElementById('product-price').value);
        const amount = parseInt(document.getElementById('product-amount').value);
        const categoryId = parseInt(document.getElementById('product-category').value);
        const submitBtn = document.getElementById('product-submit-btn');

        if (!name.trim() || !price || !amount || !categoryId) {
            showNotification('error', 'Xatolik', 'Barcha majburiy maydonlarni to\'ldiring');
            return;
        }

        try {
            setButtonLoading(submitBtn, true);

            const productData = {
                name: name.trim(),
                description: description.trim(),
                price: price,
                amount: amount,
                categoryId: categoryId,
                attachmentIds: uploadedProductFiles.map(file => file.id)
            };

            console.log('Sending product data:', productData);

            const response = await api.post('/api/products/admin', productData);

            console.log('Product creation response:', response.data);

            showNotification('success', 'Muvaffaqiyat', 'Mahsulot muvaffaqiyatli qo\'shildi');

            // Reset form
            document.getElementById('product-form').reset();
            uploadedProductFiles = [];
            displayUploadedFiles('product');

            // Reload data
            await loadProducts();
            await loadDashboardData();

        } catch (error) {
            console.error('Product creation error:', error);
            console.error('Error response:', error.response?.data);

            let message = 'Mahsulot qo\'shishda xatolik yuz berdi';
            if (error.response?.data?.message) {
                message = error.response.data.message;
            } else if (error.response?.status === 400) {
                message = 'Noto\'g\'ri ma\'lumotlar yuborildi';
            } else if (error.response?.status === 401) {
                message = 'Ruxsat berilmagan. Qayta kiring.';
            } else if (error.response?.status === 500) {
                message = 'Server xatoligi. Iltimos, qayta urinib ko\'ring.';
            }

            showNotification('error', 'Xatolik', message);
        } finally {
            setButtonLoading(submitBtn, false);
        }
    }

    function setButtonLoading(button, loading) {
        if (loading) {
            button.disabled = true;
            const originalText = button.innerHTML;
            button.setAttribute('data-original-text', originalText);
            button.innerHTML = '<span class="loading-spinner"></span>Yuklanmoqda...';
        } else {
            button.disabled = false;
            const originalText = button.getAttribute('data-original-text');
            if (originalText) {
                button.innerHTML = originalText;
            }
        }
    }

    // ======================================================
    // DATA LOADING FUNCTIONS
    // ======================================================
    async function loadDashboardData() {
        console.log('Loading dashboard data...');
        try {
            // Load data in parallel but handle errors individually
            const results = await Promise.allSettled([
                loadCategories(),
                loadProducts(),
                loadUsers()
            ]);

            // Check if any failed
            results.forEach((result, index) => {
                if (result.status === 'rejected') {
                    console.error(`Failed to load data ${index}:`, result.reason);
                }
            });

            updateDashboardStats();
        } catch (error) {
            console.error('Dashboard loading error:', error);
            showNotification('error', 'Xatolik', 'Dashboard ma\'lumotlarini yuklashda xatolik');
        }
    }

    function updateDashboardStats() {
        // Update stats
        document.getElementById('total-categories').textContent = allCategories.length;
        document.getElementById('total-products').textContent = allProducts.length;
        document.getElementById('total-users').textContent = allUsers.length;
        document.getElementById('low-stock-products').textContent = allProducts.filter(p => p.amount < 5).length;

        // Display recent categories
        const recentCategories = allCategories.slice(-5).reverse();
        const recentCategoriesContainer = document.getElementById('recent-categories');
        if (recentCategoriesContainer) {
            recentCategoriesContainer.innerHTML = recentCategories.length > 0 ?
                recentCategories.map(cat => `
                        <div class="d-flex align-items-center mb-2">
                            <div class="me-3">
                                <i class="fas fa-tag text-primary"></i>
                            </div>
                            <div>
                                <div class="fw-bold">${cat.name}</div>
                                <small class="text-muted">ID: ${cat.id}</small>
                            </div>
                        </div>
                    `).join('') : '<p class="text-muted">Kategoriyalar mavjud emas</p>';
        }

        // Display recent products
        const recentProducts = allProducts.slice(-5).reverse();
        const recentProductsContainer = document.getElementById('recent-products');
        if (recentProductsContainer) {
            recentProductsContainer.innerHTML = recentProducts.length > 0 ?
                recentProducts.map(prod => `
                        <div class="d-flex align-items-center mb-2">
                            <div class="me-3">
                                <i class="fas fa-box text-success"></i>
                            </div>
                            <div>
                                <div class="fw-bold">${prod.name}</div>
                                <small class="text-muted">${formatPrice(prod.price)} So'm</small>
                            </div>
                        </div>
                    `).join('') : '<p class="text-muted">Mahsulotlar mavjud emas</p>';
        }
    }

    async function loadCategories() {
        const loading = document.getElementById('categories-loading');
        const tableBody = document.getElementById('categories-table-body');
        const categorySelect = document.getElementById('product-category');

        try {
            if (loading) loading.classList.add('show');

            console.log('Loading categories...');
            const response = await api.get('/api/v1/category/all-active');
            allCategories = response.data || [];

            console.log('Categories loaded:', allCategories);

            // Update table
            if (tableBody) {
                tableBody.innerHTML = allCategories.length > 0 ?
                    allCategories.map(category => {
                        // Handle both 'active' and '_active' field names
                        const isActive = category.active !== undefined ? category.active : category._active;
                        return `
                                <tr>
                                    <td>${category.id}</td>
                                    <td>
                                        ${category.attachments ?
                            `<img src="${API_BASE_URL}/api/v1/attachment/${category.attachment.id}" class="image-preview" alt="${category.name}">` :
                            '<i class="fas fa-image text-muted"></i>'
                        }
                                    </td>
                                    <td>${category.name}</td>
                                    <td>
                                        <span class="badge-custom ${isActive ? '' : 'badge-inactive'}">
                                            ${isActive ? 'Faol' : 'Nofaol'}
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn btn-outline-custom btn-sm me-2" onclick="editCategory(${category.id})">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm" onclick="deleteCategory(${category.id})">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            `;
                    }).join('') : '<tr><td colspan="5" class="text-center">Kategoriyalar mavjud emas</td></tr>';
            }

            // Update category select in product form
            if (categorySelect) {
                console.log('Updating category select with', allCategories.length, 'categories');

                // Filter active categories - handle both 'active' and '_active' field names
                const activeCategories = allCategories.filter(cat =>
                    (cat.active !== undefined ? cat.active : cat._active)
                );

                console.log('Active categories:', activeCategories.length);

                // Clear existing options
                categorySelect.innerHTML = '<option value="">Kategoriyani tanlang</option>';

                // Add new options
                if (activeCategories.length > 0) {
                    activeCategories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.id;
                        option.textContent = category.name;
                        categorySelect.appendChild(option);
                    });
                } else {
                    // Add a disabled option if no categories
                    const option = document.createElement('option');
                    option.disabled = true;
                    option.textContent = 'Faol kategoriyalar mavjud emas';
                    categorySelect.appendChild(option);
                }
            } else {
                console.warn('Category select element not found');
            }

            if (loading) loading.classList.remove('show');
        } catch (error) {
            console.error('Categories loading error:', error);
            if (loading) {
                loading.innerHTML = '<p class="text-danger">Kategoriyalarni yuklashda xatolik yuz berdi</p>';
            }
            if (tableBody) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Kategoriyalarni yuklashda xatolik yuz berdi</td></tr>';
            }
            throw error;
        }
    }

    async function loadProducts() {
        const loading = document.getElementById('products-loading');
        const tableBody = document.getElementById('products-table-body');

        try {
            if (loading) loading.classList.add('show');

            console.log('Loading products...');
            const response = await api.get('/api/products/admin');
            allProducts = response.data || [];

            console.log('Products loaded:', allProducts);

            if (tableBody) {
                tableBody.innerHTML = allProducts.length > 0 ?
                    allProducts.map(product => {
                        // Handle different attachment field names
                        const attachments = product.attachments || product.attachmentIds || [];
                        const firstAttachment = attachments.length > 0 ? attachments[0] : null;

                        // Find category name
                        const category = allCategories.find(c => c.id === product.categoryId);
                        const categoryName = category ? category.name : 'N/A';

                        return `
                                <tr>
                                    <td>${product.id}</td>
                                    <td>
                                        ${firstAttachment ?
                            `<img src="${API_BASE_URL}/api/v1/attachment/${firstAttachment.id}" class="image-preview" alt="${product.name}">` :
                            '<i class="fas fa-image text-muted"></i>'
                        }
                                    </td>
                                    <td>${product.name}</td>
                                    <td>${formatPrice(product.price)} So'm</td>
                                    <td>
                                        <span class="badge-custom ${product.amount < 5 ? 'badge-inactive' : ''}">
                                            ${product.amount}
                                        </span>
                                    </td>
                                    <td>${categoryName}</td>
                                    <td>
                                        <button class="btn btn-outline-danger btn-sm" onclick="deleteProduct(${product.id})">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            `;
                    }).join('') : '<tr><td colspan="7" class="text-center">Mahsulotlar mavjud emas</td></tr>';
            }

            if (loading) loading.classList.remove('show');
        } catch (error) {
            console.error('Products loading error:', error);
            if (loading) {
                loading.innerHTML = '<p class="text-danger">Mahsulotlarni yuklashda xatolik yuz berdi</p>';
            }
            if (tableBody) {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Mahsulotlarni yuklashda xatolik yuz berdi</td></tr>';
            }
            throw error;
        }
    }

    async function loadUsers() {
        try {
            console.log('Loading users...');
            const response = await api.get('/api/user/admin');
            allUsers = response.data || [];
            console.log('Users loaded:', allUsers);
        } catch (error) {
            console.error('Users loading error:', error);
            allUsers = [];
            throw error;
        }
    }

    // ======================================================
    // CRUD OPERATIONS
    // ======================================================
    function editCategory(categoryId) {
        const category = allCategories.find(cat => cat.id === categoryId);
        if (!category) return;

        document.getElementById('edit-category-id').value = category.id;
        document.getElementById('edit-category-name').value = category.name;

        // Handle both 'active' and '_active' field names
        const isActive = category.active !== undefined ? category.active : category._active;
        document.getElementById('edit-category-active').checked = isActive;

        const modal = new bootstrap.Modal(document.getElementById('editCategoryModal'));
        modal.show();
    }

    async function updateCategory() {
        const id = document.getElementById('edit-category-id').value;
        const name = document.getElementById('edit-category-name').value;
        const active = document.getElementById('edit-category-active').checked;

        try {
            const updateData = {
                name: name.trim(),
                active: active
            };

            console.log('Updating category:', updateData);

            await api.post(`/api/v1/category/${id}`, updateData);

            showNotification('success', 'Muvaffaqiyat', 'Kategoriya muvaffaqiyatli yangilandi');
            bootstrap.Modal.getInstance(document.getElementById('editCategoryModal')).hide();
            await loadCategories();
            await loadDashboardData();
        } catch (error) {
            console.error('Category update error:', error);
            const message = error.response?.data?.message || 'Kategoriyani yangilashda xatolik yuz berdi';
            showNotification('error', 'Xatolik', message);
        }
    }

    async function deleteCategory(categoryId) {
        if (!confirm('Kategoriyani o\'chirishni xohlaysizmi?')) return;

        try {
            console.log('Deleting category:', categoryId);
            await api.delete(`/api/v1/category/${categoryId}`);
            showNotification('success', 'Muvaffaqiyat', 'Kategoriya muvaffaqiyatli o\'chirildi');
            await loadCategories();
            await loadDashboardData();
        } catch (error) {
            console.error('Category delete error:', error);
            const message = error.response?.data?.message || 'Kategoriyani o\'chirishda xatolik yuz berdi';
            showNotification('error', 'Xatolik', message);
        }
    }

    async function deleteProduct(productId) {
        if (!confirm('Mahsulotni o\'chirishni xohlaysizmi?')) return;

        try {
            console.log('Deleting product:', productId);
            await api.delete(`/api/products/admin/${productId}`);
            showNotification('success', 'Muvaffaqiyat', 'Mahsulot muvaffaqiyatli o\'chirildi');
            await loadProducts();
            await loadDashboardData();
        } catch (error) {
            console.error('Product delete error:', error);
            const message = error.response?.data?.message || 'Mahsulotni o\'chirishda xatolik yuz berdi';
            showNotification('error', 'Xatolik', message);
        }
    }

    // ======================================================
    // UTILITY FUNCTIONS
    // ======================================================
    function formatPrice(price) {
        return new Intl.NumberFormat('uz-UZ').format(price);
    }

    function goToMainSite() {
        window.location.href = 'index.html';
    }

    function logout() {
        console.log('Logging out...');
        localStorage.removeItem('accessToken');
        localStorage.removeItem('refreshToken');
        localStorage.removeItem('token');
        showNotification('success', 'Chiqish', 'Muvaffaqiyatli chiqildi');
        setTimeout(() => {
            window.location.href = 'login.html';
        }, 1000);
    }

    function showNotification(type, title, message) {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 350px;';

        notification.innerHTML = `
                <strong>${title}:</strong> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;

        document.body.appendChild(notification);

        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 6000);
    }
</script>
</body>
</html>
